```
TG: 001
Title: Implementation guide for payment providers
Author: Mike Gaertner <gaertner.mike@sabay.com>, Owen Jacob <jacob.owen@sabay.com>
Status: Active
Created: 2019-08-25
Updated: 2020-03-04
Version 2.0.0
```

Implementation guide for payment providers
==========================================

This document describes the account setup and API implementation required to be completed by payment providers who wish to integrate with SSN.

# SSN account setup

This is a one time process although payment providers may wish to complete it programmatically so that the setup can be stored in version control for future reference. The following documents provide information on correctly setting up SSN accounts:

* Account settings [TR001](/tr/tr001.md)
* KYC settings [TR006](/tr/tr006.md)

# Implementation of a payment provider API on SSN

## Status and Info endpoints

These endpoints can be used to determine the status of the payment provider's SSN API. The endpoint designs are documented here: [status](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/info/get_status) and [info](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/info/getInfo).

## One time payments

One time payments are where the payment provider prompts the user for payment authorization for each transaction.

### One time payments flow

The endpoint design is documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/payments/post_charge_onetime__payment_address_).

Source code examples:

* [Go](/examples/go/onetimecharge.go)

#### Step 1 - Verify the requst signature is valid

The payment provider should take the full request URL, sha256 hash the url and encode the result in hex to compare to the request hash (examples [here](tg/tg006.md#creating-messages)). The SSN API can then be used to verify the signature using the endpoint documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/verify/post_verify_signature). A HTTP 200 response indicates the signature is valid.

#### Step 2 - Resolve the payment address

The payment provider should prepare the request to the payment address resolver as documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Address%20Resolver%20APIv2#/resolver/post_resolve__payment_address_). The resolver response will provide the payment provider with information to complete the transaction. There are several possible responses that should inform the payment provider's next step before completing the payment:

If the payment array:
* Contains only a single object with just an asset_code present -> the payment provider should prompt the user for an amount in that currency.
* Contains multiple objects with just asset_codes present -> the payment provider should prompt the user for an amount and the currency they wish to pay in.
* Contains only a single object with an asset_code and an amount present -> the payment provider should prompt the user to confirm the payment amount and currency.
* Contains multiple objects with asset_codes and amounts present -> the payment provider should prompt the user to confirm the payment amount and choose which currency they wish to pay in

#### Step 3 - Optionally check the trustline is valid

The resolver for the payment address should already have checked a trustline was in place but the payment provider can ensure this by also checking the trustline using the endpoint [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/verify/post_verify_trust).

#### Step 4 - User authorizes the payment; Payment provider moves the amount to escrow

The payment provider's usual payment authorization options can be used here. Once the user has authorized the payment the payment provider should move the funds from the users account to an escrow account that holds SSN funds at the payment provider.

#### Step 5 - Build and Sign the payment for SSN

Using the information from the resolved payment address along with the users input the payment provider can use the endpoint documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/transactions/post_create_transaction) to build a payment transaction for SSN. The transaction should be signed by the payment provider key(s) and then submitted to the endpoint [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/transactions/post_transactions). The response of the transaction endpoint will include the network ledger number and the network transaction hash provided the transaction was sucessfully accepted.

If a redirect URL was provided in the original request the payment provider should redirect to that URL with the transaction hash otherwise the payment provider can show the user a success screen along with the hash for the users records.

## Pre-authorized payments

Pre-authorized payments are where the payment provider prompts the user for authorization once and then a merchant is able to pull transactions. The payment provider can optionally prompt the user for transaction limits.

### Adding Pre-authorized permission flow

The endpoint design is documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/authorization/post_authorize__public_key___ssn_account_).

Source code examples:

* [Go](/examples/go/addpreauth.go)

### Pre-authorized payments flow

The endpoint design is documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/payments/post_charge_auth__payment_address_).

Source code examples:

* [Go](/examples/go/preauthcharge.go)

### Deleting Pre-authorized permission flow

The endpoint design is documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/authorization/delete_authorize__public_key___ssn_account_).

Source code examples:

* [Go](/examples/go/delpreauth.go)

# Implementation of a payment provider settlement service


# Incoming transactions to the payment providers accounts

A payment providers account must be able to process incoming transactions for 

1) settlement with merchant
2) refunds to user account
3) rejected payments

The settlement process is described in more detail in TR004 [Settlement on SSN](../tr/tr004.md). 

When the payment provider receives a incoming transaction he should verify first if the transaction memo is a hash or a text string. If the memo type is a hash then the incoming transaction is a rejected transaction by a merchant. If the memo type is text and the memo contains a valid account number at the payment providers system, then the transaction should be processed as settlement or refund.

## Rejected transactions

If a merchant receives a payment which cannot be processed or where the user has canceled the order after the payment was made, the merchant can reject the payment by reversing the transaction. Rejects are implemented by sending the received amount back to the originating sender address and referencing the original transaction hash in the memo field.

The payment provider needs to process the refund by 

* checking the transaction hash in the memo
* finding the original transaction details
* refunding the amount to the users account
* notifying the user about the refund

No fees should be charged for the refund transaction. The merchant has to pay the network fees for the refund transaction.

## Settlement or refunds

When the merchant want to redeem tokens to his account, or make a partial refund to a user, the merchant will construct a transaction on SSN to return payment providers tokens to the asset issuing account, with a memo containing a valid using account (the ISO 13616:2007 standard for International Bank Account Number) for the payment providers (e.g. bank account or wallet account number).

The payment provider needs to process the transaction by:

* checking the account number in the memo
* deducting commissions and fees 
* crediting from escrow the amount due to the users account
* notifying the user about within its eco system
